<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Lane - A Relaxing Puzzle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="beach.png" type="image/svg+xml" style="border-radius: 50%;" width="96" height="96">
    <style>
        /* --- Fonts & Colors (Warm, Nostalgic Palette) --- */
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600&display=swap');

        :root {
            --bg-color: #F4ECE2; /* Creamy background */
            --text-color: #4A3F35; /* Dark Sepia for text */
            --accent-color: #A67B5B; /* Warm Brown for borders/accents */
            --button-color: #C8A17D; /* Soft Gold for buttons */
            --button-hover: #B08B66;
            --highlight: #FFD700; /* Gold glow for selection */
            --frame-color: #8C6A4A;
            --timer-color: #8B4513;
            --warning-color: #D9534F;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(135deg, #F4ECE2 0%, #E8D9C5 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            user-select: none; /* Prevents accidental text highlighting */
            position: relative;
        }

        /* Back Button */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            text-decoration: none;
        }

        .back-button:hover {
            background-color: var(--button-hover);
            transform: translateX(-3px);
        }

        h1 {
            font-family: 'Merriweather', serif;
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: var(--accent-color);
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            padding-bottom: 15px;
        }

        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--accent-color), transparent);
        }

        p.instructions {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 25px;
            max-width: 600px;
            line-height: 1.5;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        /* --- Game Stats --- */
        .game-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }

        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
            border-left: 4px solid var(--accent-color);
            transition: all 0.3s ease;
        }

        .stat-box.warning {
            border-left-color: var(--warning-color);
            animation: pulse-warning 1s infinite;
        }

        @keyframes pulse-warning {
            0% { box-shadow: 0 0 0 0 rgba(217, 83, 79, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(217, 83, 79, 0); }
            100% { box-shadow: 0 0 0 0 rgba(217, 83, 79, 0); }
        }

        .stat-label {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--timer-color);
            font-family: 'Merriweather', serif;
        }

        .stat-value.warning {
            color: var(--warning-color);
        }

        /* --- Controls Area --- */
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        button {
            font-family: 'Merriweather', serif;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 12px 24px;
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.15);
        }

        button:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        /* --- Puzzle Container --- */
        #puzzle-container {
            position: relative;
            width: 600px;
            height: 600px;
            background-color: var(--accent-color);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.2), 
                0 10px 30px rgba(0,0,0,0.15),
                0 0 0 10px var(--frame-color),
                0 0 0 15px #D2B48C;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }

        #puzzle-container:hover {
            transform: translateY(-5px);
        }

        /* The Grid of Tiles */
        #puzzle-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            gap: 5px;
        }

        /* Individual Tile */
        .tile {
            position: relative;
            background-size: 600px 600px; /* Match container size */
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            /* Vintage Photo Filter Effect */
            filter: sepia(0.6) contrast(1.1) brightness(0.9);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .tile:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.03);
            z-index: 1;
        }

        .tile:hover {
            filter: sepia(0.6) contrast(1.1) brightness(1.05);
            transform: scale(1.02);
            z-index: 5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Style for the selected tile */
        .tile.selected {
            outline: 4px solid var(--highlight);
            box-shadow: 0 0 15px var(--highlight);
            z-index: 10;
            transform: scale(1.05);
            filter: sepia(0.4) contrast(1.2) brightness(1.1);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px var(--highlight); }
            50% { box-shadow: 0 0 20px var(--highlight); }
            100% { box-shadow: 0 0 10px var(--highlight); }
        }

        /* --- Preview Overlay --- */
        #preview-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            width: calc(100% - 20px);
            height: calc(100% - 20px);
            background-size: cover;
            border-radius: 4px;
            opacity: 0;
            pointer-events: none; /* Let clicks pass through */
            transition: opacity 0.3s;
            z-index: 20;
            /* Apply same vintage filter */
            filter: sepia(0.6) contrast(1.1) brightness(0.9);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        /* --- Audio Controls --- */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .audio-controls label {
            font-weight: bold;
            color: var(--accent-color);
        }

        .audio-slider {
          
            width: 150px;
            height: 8px;
            border-radius: 4px;
            background: #E0D2C1;
            outline: none;
        }

        .audio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--button-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- Victory Message --- */
        #victory-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, #FFF9F0 0%, #FFFAF5 100%);
            padding: 40px 60px;
            border-radius: 20px;
            border: 8px solid var(--accent-color);
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy effect */
            z-index: 100;
            max-width: 500px;
            width: 90%;
        }

        #victory-message.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        #victory-message h2 {
            font-family: 'Merriweather', serif;
            font-size: 3rem;
            color: var(--accent-color);
            margin: 0 0 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .victory-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .victory-stat {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .victory-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--timer-color);
        }

        .popup-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        /* --- Time's Up Message --- */
        #timeup-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, #FFF9F0 0%, #FFFAF5 100%);
            padding: 40px 60px;
            border-radius: 20px;
            border: 8px solid var(--warning-color);
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
            max-width: 500px;
            width: 90%;
        }

        #timeup-message.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        #timeup-message h2 {
            font-family: 'Merriweather', serif;
            font-size: 3rem;
            color: var(--warning-color);
            margin: 0 0 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* Responsive adjustments for smaller screens/tablets */
        @media (max-width: 650px) {
            #puzzle-container {
                width: 90vw;
                height: 90vw;
            }
            .tile {
                background-size: 90vw 90vw;
            }
            h1 { font-size: 2.2rem; }
            p.instructions { font-size: 1rem; }
            button { font-size: 1rem; padding: 10px 16px; }
            .game-stats {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            .stat-box {
                width: 80%;
            }
            .back-button {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            .popup-buttons {
                flex-direction: column;
                align-items: center;
            }
            .popup-buttons button {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>

    <!-- Back Button -->
    <a href="index.html" class="back-button">
        <i class="fas fa-arrow-left"></i>
    </a>

    <h1>Memory Lane: Picture Puzzle</h1>
    <p class="instructions">
        Relax and rebuild the vintage photo in under 1 minute! <br>
        Click a piece to select it, then click another to swap their places.
    </p>

    <div class="game-stats">
        <div class="stat-box" id="timer-box">
            <div class="stat-label">Time Left</div>
            <div class="stat-value" id="timer">01:00</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Moves</div>
            <div class="stat-value" id="move-counter">0</div>
        </div>
    </div>

    <div class="audio-controls">
        <label for="volume">Volume:</label>
        <input type="range" id="volume" class="audio-slider" min="0" max="100" value="70">
    </div>

    <div class="controls">
        <button id="preview-btn" onmousedown="showPreview()" onmouseup="hidePreview()" onmouseleave="hidePreview()" ontouchstart="showPreview()" ontouchend="hidePreview()">Hold for Preview</button>
        <button onclick="startNewGame()">New Picture</button>
    </div>

    <div id="puzzle-container">
        <div id="puzzle-grid">
            <!-- Tiles will be generated here -->
        </div>
        <div id="preview-overlay"></div>
    </div>

    <div id="victory-message">
        <h2>Wonderful!</h2>
        <p style="font-size: 1.5rem; margin-bottom: 30px;">You've completed the picture.</p>
        
        <div class="victory-stats">
            <div class="victory-stat">
                <div>Time Left</div>
                <div class="victory-stat-value" id="victory-time">00:00</div>
            </div>
            <div class="victory-stat">
                <div>Moves</div>
                <div class="victory-stat-value" id="victory-moves">0</div>
            </div>
        </div>
        
        <div class="popup-buttons">
            <button onclick="startNewGame()" style="font-size: 1.5rem; padding: 15px 30px;">Play Again</button>
            <button onclick="goBack()" style="font-size: 1.5rem; padding: 15px 30px; background-color: #6C757D;">Back to Home</button>
        </div>
    </div>

    <div id="timeup-message">
        <h2>Time's Up!</h2>
        <p style="font-size: 1.5rem; margin-bottom: 30px;">The 1-minute timer has expired.</p>
        
        <div class="victory-stats">
            <div class="victory-stat">
                <div>Pieces Correct</div>
                <div class="victory-stat-value" id="correct-pieces">0/9</div>
            </div>
            <div class="victory-stat">
                <div>Moves</div>
                <div class="victory-stat-value" id="timeup-moves">0</div>
            </div>
        </div>
        
        <div class="popup-buttons">
            <button onclick="startNewGame()" style="font-size: 1.5rem; padding: 15px 30px;">Try Again</button>
            <button onclick="goBack()" style="font-size: 1.5rem; padding: 15px 30px; background-color: #6C757D;">Back to Home</button>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const GRID_SIZE = 3; // 3x3 grid
        const TOTAL_TILES = GRID_SIZE * GRID_SIZE;
        const TIME_LIMIT = 60; // 1 minute in seconds
        // Source images from unsplash via picsum for reliability and variety
        // IDs chosen for a "vintage/classic" feel (nature, old architecture, classic items)
        const IMAGE_IDS = ['1015', '1016', '1025', '1035', '1040', '106', '1062', '1069', '1074', '1080', '1082', '1084'];
        let currentImageStyle = '';

        // --- State Variables ---
        let tiles = []; // Holds the tile elements
        let selectedTile = null; // The first tile clicked
        let isGameComplete = false;
        let moveCount = 0;
        let timeLeft = TIME_LIMIT;
        let timerInterval = null;
        let audioVolume = 0.7;

        // --- Audio Effects (using simple Web Audio API for no external files) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioVolume === 0) return;
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'click') {
                // Gentle "tap" sound
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1 * audioVolume, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.15);
            } else if (type === 'swap') {
                // Satisfying "swish/clack" sound
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(250, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(350, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.15 * audioVolume, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'win') {
                // Gentle victory chime
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                gainNode.gain.setValueAtTime(0.2 * audioVolume, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 1.5);
                
                setTimeout(() => {
                     const osc2 = audioCtx.createOscillator();
                     const gain2 = audioCtx.createGain();
                     osc2.connect(gain2);
                     gain2.connect(audioCtx.destination);
                     osc2.frequency.setValueAtTime(659.25, audioCtx.currentTime); // E5
                     gain2.gain.setValueAtTime(0.2 * audioVolume, audioCtx.currentTime);
                     gain2.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
                     osc2.start(audioCtx.currentTime);
                     osc2.stop(audioCtx.currentTime + 1.5);
                }, 200);
                
                setTimeout(() => {
                     const osc3 = audioCtx.createOscillator();
                     const gain3 = audioCtx.createGain();
                     osc3.connect(gain3);
                     gain3.connect(audioCtx.destination);
                     osc3.frequency.setValueAtTime(783.99, audioCtx.currentTime); // G5
                     gain3.gain.setValueAtTime(0.2 * audioVolume, audioCtx.currentTime);
                     gain3.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
                     osc3.start(audioCtx.currentTime);
                     osc3.stop(audioCtx.currentTime + 1.5);
                }, 400);
            } else if (type === 'timeup') {
                // Urgent beep for time running out
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.2 * audioVolume, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.5);
            }
        }

        // --- Timer Functions ---
        function startTimer() {
            timeLeft = TIME_LIMIT;
            updateTimerDisplay();
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimer() {
            timeLeft--;
            updateTimerDisplay();
            
            // Add warning effect when time is running low
            if (timeLeft <= 10) {
                document.getElementById('timer-box').classList.add('warning');
                document.getElementById('timer').classList.add('warning');
                
                // Play warning sound for last 5 seconds
                if (timeLeft <= 5 && timeLeft > 0) {
                    playSound('timeup');
                }
            }
            
            if (timeLeft <= 0) {
                stopTimer();
                timeUp();
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        }

        function resetTimer() {
            stopTimer();
            timeLeft = TIME_LIMIT;
            updateTimerDisplay();
            document.getElementById('timer-box').classList.remove('warning');
            document.getElementById('timer').classList.remove('warning');
        }

        // --- Initialization ---
        function startNewGame() {
            const gridElement = document.getElementById('puzzle-grid');
            gridElement.innerHTML = ''; // Clear existing grid
            tiles = [];
            selectedTile = null;
            isGameComplete = false;
            moveCount = 0;
            document.getElementById('move-counter').textContent = '0';
            document.getElementById('victory-message').classList.remove('show');
            document.getElementById('timeup-message').classList.remove('show');
            resetTimer();

            // 1. Choose a new image
            const randomId = IMAGE_IDS[Math.floor(Math.random() * IMAGE_IDS.length)];
            // Use a high-res square image
            currentImageStyle = `url('https://picsum.photos/id/${randomId}/800/800')`;
            document.getElementById('preview-overlay').style.backgroundImage = currentImageStyle;

            // 2. Create the tiles
            let positions = [];
            for (let i = 0; i < TOTAL_TILES; i++) {
                positions.push(i); // Create an array [0, 1, ..., 8]
            }

            // 3. Shuffle the positions array to randomize starting locations
            // Using Fisher-Yates shuffle algorithm
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }
            
            // Ensure it's not solved initially (rare, but possible)
            let isSolved = true;
            for(let i=0; i<TOTAL_TILES; i++) { if(positions[i] !== i) isSolved = false; }
            if(isSolved) {
                // Simple fix: just swap the last two if it accidentally shuffled into a solved state
                [positions[TOTAL_TILES-1], positions[TOTAL_TILES-2]] = [positions[TOTAL_TILES-2], positions[TOTAL_TILES-1]];
            }

            // 4. Build the DOM elements based on shuffled positions
            for (let i = 0; i < TOTAL_TILES; i++) {
                const tile = document.createElement('div');
                tile.classList.add('tile');
                
                // Calculate the CORRECT position for background (where this piece belongs)
                // The position in the shuffled array tells us which piece goes here.
                const pieceIndex = positions[i]; 
                const correctRow = Math.floor(pieceIndex / GRID_SIZE);
                const correctCol = pieceIndex % GRID_SIZE;
                
                // Set background position to show the correct part of the image
                // E.g., for a 3x3 grid, positions are 0%, 50%, 100%
                const bgX = (correctCol / (GRID_SIZE - 1)) * 100;
                const bgY = (correctRow / (GRID_SIZE - 1)) * 100;
                
                tile.style.backgroundImage = currentImageStyle;
                tile.style.backgroundPosition = `${bgX}% ${bgY}%`;
                
                // Store data needed for game logic
                tile.dataset.currentIndex = i; // Where it is right now on the grid (0-8)
                tile.dataset.correctIndex = pieceIndex; // Where it *should* be (0-8)

                tile.addEventListener('click', handleTileClick);
                gridElement.appendChild(tile);
                tiles.push(tile);
            }
            
            // Start the timer
            startTimer();
        }

        // --- Game Logic ---
        function handleTileClick(e) {
            if (isGameComplete || timeLeft <= 0) return;
            const clickedTile = e.target;

            // Case 1: No tile is currently selected
            if (selectedTile === null) {
                selectedTile = clickedTile;
                selectedTile.classList.add('selected');
                playSound('click');
            } 
            // Case 2: The SAME tile is clicked again (deselect)
            else if (selectedTile === clickedTile) {
                selectedTile.classList.remove('selected');
                selectedTile = null;
                playSound('click');
            } 
            // Case 3: A DIFFERENT tile is clicked (perform swap)
            else {
                swapTiles(selectedTile, clickedTile);
                selectedTile.classList.remove('selected');
                selectedTile = null;
                moveCount++;
                document.getElementById('move-counter').textContent = moveCount;
                playSound('swap');
                checkWinCondition();
            }
        }

        function swapTiles(tile1, tile2) {
            // Swap background styles (the visual part)
            const tempBg = tile1.style.backgroundPosition;
            tile1.style.backgroundPosition = tile2.style.backgroundPosition;
            tile2.style.backgroundPosition = tempBg;

            // Swap data attributes (the logic part)
            const tempCorrectIndex = tile1.dataset.correctIndex;
            tile1.dataset.correctIndex = tile2.dataset.correctIndex;
            tile2.dataset.correctIndex = tempCorrectIndex;
            // Note: dataset.currentIndex remains fixed based on DOM position
        }

        function checkWinCondition() {
            let allCorrect = true;
            tiles.forEach(tile => {
                // A tile is correct if its current grid position matches the piece it's holding
                if (tile.dataset.currentIndex !== tile.dataset.correctIndex) {
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                isGameComplete = true;
                stopTimer();
                playSound('win');
                
                // Update victory stats
                document.getElementById('victory-time').textContent = document.getElementById('timer').textContent;
                document.getElementById('victory-moves').textContent = moveCount;
                
                setTimeout(() => {
                    document.getElementById('victory-message').classList.add('show');
                }, 500);
            }
        }

        function timeUp() {
            isGameComplete = true;
            
            // Count correct pieces
            let correctPieces = 0;
            tiles.forEach(tile => {
                if (tile.dataset.currentIndex === tile.dataset.correctIndex) {
                    correctPieces++;
                }
            });
            
            // Update time's up message
            document.getElementById('correct-pieces').textContent = `${correctPieces}/${TOTAL_TILES}`;
            document.getElementById('timeup-moves').textContent = moveCount;
            
            setTimeout(() => {
                document.getElementById('timeup-message').classList.add('show');
            }, 500);
        }

        // --- Preview Logic ---
        function showPreview() {
            if(isGameComplete || timeLeft <= 0) return;
            document.getElementById('preview-overlay').style.opacity = 1;
        }

        function hidePreview() {
            document.getElementById('preview-overlay').style.opacity = 0;
        }

        // --- Back Button Function ---
        function goBack() {
            if (confirm("Are you sure you want to return to the home page?")) {
                window.location.href = "index.html";
            }
        }

        // --- Volume Control ---
        document.getElementById('volume').addEventListener('input', function() {
            audioVolume = this.value / 100;
        });

        // Start the game on load
        // Need a user interaction first to unlock AudioContext
        let audioUnlocked = false;
        document.body.addEventListener('click', () => {
            if(!audioUnlocked) {
                audioCtx.resume();
                audioUnlocked = true;
            }
        }, { once: true });

        startNewGame();

    </script>
</body>

</html>
